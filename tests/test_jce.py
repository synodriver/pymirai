# -*- coding: utf-8 -*-
import unittest

from pyjce import JceReader, JceWriter

from pymirai.binary.jce.struct import RequestPacket, RequestDataVersion2
from pymirai import binary

data = bytes.fromhex(
    "100129000b0a160e3139332e3131322e3233312e3630211f9030014c5c600870018602737a96066f74686572730b0a160d34322e38312e3137322e323135211f9030014c5c600870018602746a960374656c0b0a160b31342e32322e332e313134211f9030014c5c600870018602737a960374656c0b0a160e31342e3231352e3133382e3131302101bb30014c5c600870018602737a960374656c0b0a160d34322e38312e3136392e313030205030014c5c600870018602746a960374656c0b0a160e3131342e3232312e3134342e37362136b030014c5c6008700186027368960374656c0b0a160d3131332e39362e31322e3232342101bb30014c5c600870018602737a960374656c0b0a160d34322e38312e3137302e313232211f9030014c5c600870018602746a960374656c0b0a160e3131342e3232312e3134382e3637205030014c5c6008700186027368960374656c0b0a16116d7366776966692e33672e71712e636f6d211f9030014c5c60087c86066f746865727396066f74686572730b0a160c34322e38312e3137322e3633205030014c5c600870018602746a960374656c0b39000b0a160e3139332e3131322e3233312e3630211f9030014c5c600870018602737a96066f74686572730b0a160d34322e38312e3137322e323135211f9030014c5c600870018602746a960374656c0b0a160b31342e32322e332e313134211f9030014c5c600870018602737a960374656c0b0a160e31342e3231352e3133382e3131302101bb30014c5c600870018602737a960374656c0b0a160d34322e38312e3136392e313030205030014c5c600870018602746a960374656c0b0a160e3131342e3232312e3134342e37362136b030014c5c6008700186027368960374656c0b0a160d3131332e39362e31322e3232342101bb30014c5c600870018602737a960374656c0b0a160d34322e38312e3137302e313232211f9030014c5c600870018602746a960374656c0b0a160e3131342e3232312e3134382e3637205030014c5c6008700186027368960374656c0b0a16116d7366776966692e33672e71712e636f6d211f9030014c5c60087c86066f746865727396066f74686572730b0a160c34322e38312e3137322e3633205030014c5c600870018602746a960374656c0b425fe636545138406c7c80029005acbcc900050a160e3130392e3234342e3132392e3135205030014c500360087c8602737a96066f74686572730b0a160d34322e38312e3136392e313035205030014c500360087c8602746a960374656c0b0a160c3131332e39362e31332e3434205030014c500360087c8602737a960374656c0b0a160e3131342e3232312e3134342e3232205030014c500360087c86027368960374656c0b0a160d34322e38312e3136392e313035205030014c500360087c8602746a960374656c0bd900050a160e3130392e3234342e3132392e3135205030014c500360087c8602737a96066f74686572730b0a160d34322e38312e3136392e313035205030014c500360087c8602746a960374656c0b0a160c3131332e39362e31332e3434205030014c500360087c8602737a960374656c0b0a160e3131342e3232312e3134342e3232205030014c500360087c86027368960374656c0b0a160d34322e38312e3136392e313035205030014c500360087c8602746a960374656c0bed000cf90f0cf9100cf9110cf01202f113ff38f61428323032302d31322d32352032323a35383a32382064656c6976657279696e67206120706f6c6963790b")


def pack_uni_request_data(data: bytes):
    r = bytes([0x0A]) + data + bytes([0x0B])
    return r


class TestJce(unittest.TestCase):
    def test_decode(self):
        # with open("datas", "rb") as f:
        #     data = f.read()
        # reader = JceReader(b'\x1c,0\x01F\x0500000Pdb \x02\xf9\x0bv\x0f827817585121850\x8c\x9c\xac\xbc\xcc\xdc\xe0\x01')
        reader = JceReader(data)
        # while True:
        #     head, _ = reader.peak_head()
        #     print(reader.read_any(head.tag))
        SsoServerInfo_data = reader.read_list(2)
        print(SsoServerInfo_data)
        self.assertEqual(len(SsoServerInfo_data), 11)
        # self.assertEqual(reader.buffer.position,100)

    def test_jce_writer_schema(self):
        data = RequestPacket(iversion=1, cpacket_type=b"12", imessage_type=3, irequest_id=4, sservant_name="5",
                             sfunc_name="6", sbuffer=b"7", itimeout=8, context={"1": "2"}, status={"msg": "ok"})
        for field_name, val in data.schema()["properties"].items():
            jce_id: int = val["jce_id"]
            print(getattr(data, field_name), jce_id)

    def test_jce_long(self):
        payload = JceWriter().write_int64(0, 1).write_int64(0, 2).write_byte(bytes([1]), 3) \
            .write_string("00000", 4).write_int32(100, 5).write_int32(537065739, 6).write_string(
            "468356291846738", 7) \
            .write_int64(0, 8).write_int64(0, 9).write_int64(0, 10).write_int64(0, 11).write_byte(bytes([0]), 12) \
            .write_int64(0, 13).write_byte(bytes([1]), 14).bytes()

        self.assertEqual(payload, bytes.fromhex(
            "1c2c3001460530303030305064622002f90b760f3436383335363239313834363733388c9cacbcccdce001"))

    def test_encode_map(self):
        payload = bytes.fromhex(
            "1c2c3001460530303030305064622002f90b760f3436383335363239313834363733388c9cacbcccdce001")

        buf = RequestDataVersion2(
            map={"HttpServerListReq": {"ConfigHttp.HttpServerListReq": pack_uni_request_data(payload)}})

        self.assertEqual(buf.to_bytes(), bytes.fromhex(
            "0800010611487474705365727665724c697374526571180001061c436f6e666967487474702e487474705365727665724c6973745265711d00002d0a1c2c3001460530303030305064622002f90b760f3436383335363239313834363733388c9cacbcccdce0010b"))

    def test_tlv(self):
        buf = bytes.fromhex(
            "0800010611487474705365727665724c697374526571180001061c436f6e666967487474702e487474705365727665724c6973745265711d00002d0a1c2c3001460530303030305064622002f90b760f3436383335363239313834363733388c9cacbcccdce0010b")
        pkt = RequestPacket(iversion=2, sservant_name="ConfigHttp", sfunc_name="HttpServerListReq",
                            sbuffer=buf)

        self.assertEqual(bytes(pkt.to_bytes()), bytes.fromhex(
            "10022c3c4c560a436f6e666967487474706611487474705365727665724c6973745265717d0000680800010611487474705365727665724c697374526571180001061c436f6e666967487474702e487474705365727665724c6973745265711d00002d0a1c2c3001460530303030305064622002f90b760f3436383335363239313834363733388c9cacbcccdce0010b8c980ca80c"))

        # tlv
        writer = binary.Writer()
        writer.write_int_lv_packet(0, lambda w: w.write(pkt.to_bytes()))
        self.assertEqual(bytes(writer.bytes()), bytes.fromhex(
            "0000009510022c3c4c560a436f6e666967487474706611487474705365727665724c6973745265717d0000680800010611487474705365727665724c697374526571180001061c436f6e666967487474702e487474705365727665724c6973745265711d00002d0a1c2c3001460530303030305064622002f90b760f3436383335363239313834363733388c9cacbcccdce0010b8c980ca80c"))


if __name__ == "__main__":
    unittest.main()
